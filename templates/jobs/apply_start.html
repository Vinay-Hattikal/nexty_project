{% extends 'base.html' %}
{% load static %}
{% block title %}Apply — NextCareer{% endblock %}
{% block content %}
<style>
  :root {
    --primary: #0b66c3;
    --accent: #06b6d4;
    --text: #1f2937;
    --muted: #6b7280;
    --error: #dc2626;
    --bg: #f9fafb;
    --white: #ffffff;
    --radius: 10px;
    --shadow: 0 6px 18px rgba(0,0,0,0.06);
  }

  body {
    background: var(--bg);
    font-family: Inter, system-ui, sans-serif;
  }

  main {
    max-width: 800px;
    margin: 30px auto;
    background: var(--white);
    border-radius: var(--radius);
    padding: 28px;
    box-shadow: var(--shadow);
    color: var(--text);
  }

  h2 {
    font-size: 1.8rem;
    color: var(--primary);
    font-weight: 700;
    margin-bottom: 0.25rem;
  }

  h3 {
    color: var(--primary);
    font-size: 1.15rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  p {
    color: var(--muted);
    margin-bottom: 0.5rem;
  }

  .alert {
    border-radius: var(--radius);
    padding: 10px 14px;
    margin-bottom: 16px;
    font-size: 0.95rem;
  }

  .alert-error {
    background: #fdecea;
    color: #611a15;
  }

  .alert-warning {
    background: #fff4e5;
    color: #663c00;
  }

  label {
    font-weight: 500;
    cursor: pointer;
  }

  input[type="radio"] {
    margin-right: 6px;
  }

  input[type="file"], textarea {
    width: 100%;
    font-size: 1rem;
    border: 1px solid #dce6f3;
    border-radius: var(--radius);
    padding: 10px;
    transition: border 0.2s, box-shadow 0.2s;
  }

  input[type="file"]:focus,
  textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(11,102,195,0.12);
  }

  textarea {
    resize: vertical;
    min-height: 100px;
  }

  button {
    background: var(--primary);
    color: white;
    font-weight: 600;
    border: none;
    border-radius: var(--radius);
    padding: 10px 18px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
  }

  button:hover {
    background: var(--accent);
    transform: translateY(-2px);
  }

  button[type="button"] {
    background: #f3f4f6;
    color: var(--text);
    margin-left: 8px;
  }

  button[type="button"]:hover {
    background: #e5e7eb;
  }

  .muted { color: var(--muted); }

  #client-error {
    margin-top: 10px;
    border-radius: var(--radius);
    padding: 8px 10px;
    background: #fff4e5;
    color: #663c00;
    display: none;
  }

  @media (max-width: 640px) {
    main { padding: 20px; }
    h2 { font-size: 1.4rem; }
    h3 { font-size: 1rem; }
    button { width: 100%; margin-bottom: 10px; }
  }
</style>

<main>
  <h2>Apply to: {{ job.title }}</h2>
  <p><strong>Company:</strong> {{ job.company }} • <strong>Location:</strong> {{ job.location }}</p>

  {% if form.non_field_errors %}
    <div class="alert alert-error">
      {% for e in form.non_field_errors %} <div>{{ e }}</div> {% endfor %}
    </div>
  {% endif %}

  <form id="apply-form" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <h3>Choose a saved resume</h3>
    <div style="margin-bottom:8px;">
      <label>
        <input type="radio" name="resume_id" value="" id="resume-none" checked>
        (None) — I will upload a resume
      </label>
    </div>

    <div style="margin-left:10px; margin-bottom:8px;">
      {% for r in resumes %}
        <div>
          <label>
            <input type="radio" name="resume_id" value="{{ r.id }}" class="resume-radio">
            {{ r.title }} — <small class="muted">{{ r.updated_at|date:"Y-m-d" }}</small>
          </label>
        </div>
      {% empty %}
        <div>No saved resumes. Use <a href="{% url 'create_resume' %}" style="color:var(--primary);font-weight:600;">Resume Builder</a> or upload below.</div>
      {% endfor %}
    </div>

    <h3>Or upload a resume (PDF or DOCX, ≤ 5MB)</h3>
    <input type="file" name="uploaded_resume" id="uploaded_resume" accept=".pdf,.docx">
    {% if form.errors.uploaded_resume %}
      <div style="color:var(--error); font-size:0.95rem;">{{ form.errors.uploaded_resume.as_text }}</div>
    {% endif %}

    <h3>Cover Letter (optional)</h3>
    <textarea name="cover_letter" rows="6">{{ form.cover_letter.value|default_if_none:'' }}</textarea>
    {% if form.errors.cover_letter %}
      <div style="color:var(--error); font-size:0.95rem;">{{ form.errors.cover_letter.as_text }}</div>
    {% endif %}

    <div style="margin-top:18px;">
      <button type="submit" name="action" value="score">Check ATS score & Continue</button>
      <a href="{% url 'job_detail' job.id %}"><button type="button">Cancel</button></a>
    </div>

    <div id="client-error"></div>
  </form>

  <script>
  (function(){
    const fileInput = document.getElementById('uploaded_resume');
    const resumeRadios = Array.from(document.querySelectorAll('.resume-radio'));
    const resumeNone = document.getElementById('resume-none');
    const clientError = document.getElementById('client-error');
    const form = document.getElementById('apply-form');

    resumeRadios.forEach(r => {
      r.addEventListener('change', () => {
        if (r.checked) {
          fileInput.value = '';
          fileInput.disabled = true;
          clientError.style.display = 'none';
        }
      });
    });

    resumeNone.addEventListener('change', () => {
      if (resumeNone.checked) {
        fileInput.disabled = false;
      }
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length > 0) {
        resumeRadios.forEach(r => r.checked = false);
        resumeNone.checked = true;
        fileInput.disabled = false;
        clientError.style.display = 'none';
      }
    });

    form.addEventListener('submit', function(ev){
      clientError.style.display = 'none';
      let chosenResume = null;
      const radios = document.getElementsByName('resume_id');
      for (let i=0;i<radios.length;i++){
        if (radios[i].checked){
          chosenResume = radios[i].value;
          break;
        }
      }
      const filePresent = (fileInput.files && fileInput.files.length > 0);

      if (filePresent && chosenResume && chosenResume !== '') {
        ev.preventDefault();
        clientError.textContent = 'Please choose EITHER a saved resume OR upload a file — not both.';
        clientError.style.display = 'block';
        return false;
      }
      if (!filePresent && (!chosenResume || chosenResume === '')) {
        ev.preventDefault();
        clientError.textContent = 'Please choose a saved resume OR upload a resume file before proceeding.';
        clientError.style.display = 'block';
        return false;
      }
    });
  })();
  </script>
</main>
{% endblock %}
